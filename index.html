<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>HastaLuego ‚Äî Mini-jeu</title>
  <style>
    :root{
      /* Palette pixel 90s (ciel/mer/rochers) */
      --sky1:#6ec1ff; --sky2:#47a3ff;
      --sea1:#1b4d8a; --sea2:#133a69; --foam:#c7ecff;
      --sun:#ffd43b; --sunCore:#ffef99;
      --rock1:#8b5e3c; --rock2:#6d472d; --rockHL:#b07f54;
      --red:#ef4444; --green:#10b981;
      --fg:#e5e7eb; --muted:#9ca3af; --panel:#0b1022f2; --outline:#ffffff24;
      --accent:#f59e0b; --accent2:#fbbf24;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--sky1),var(--sky2));color:var(--fg)}
    body{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; display:flex; flex-direction:column; align-items:center}
    header{max-width:960px;width:100%;padding:16px}
    h1{margin:12px 0 4px;font-size:24px}
    .muted{color:var(--muted);font-size:14px;margin:0}
    .wrap{width:100%;max-width:960px;padding:0 16px 24px}
    .topbar{display:grid;grid-template-columns:1fr auto;gap:8px;margin:8px 0 12px}
    .pill{background:rgba(0,0,0,.18);border:1px solid var(--outline);padding:8px 12px;border-radius:999px;font-variant-numeric:tabular-nums}
    .board{position:relative;width:100%;aspect-ratio:16/10;border:1px solid var(--outline);border-radius:16px;overflow:hidden;background:linear-gradient(180deg,var(--sky1),var(--sky2));box-shadow:0 20px 50px rgba(0,0,0,.45)}
    canvas{position:absolute;inset:0;width:100%;height:100%;display:block;image-rendering: pixelated}
    .hint{position:absolute;right:8px;bottom:6px;color:#19324d;background:rgba(255,255,255,.35);padding:2px 6px;border-radius:8px;font-size:12px}
    .overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;padding:16px;background:rgba(0,0,0,.35)}
    .panel{width:100%;max-width:680px;background:var(--panel);border:1px solid var(--outline);border-radius:18px;padding:20px;box-shadow:0 30px 70px rgba(0,0,0,.55)}
    .panel h2{margin:0 0 8px;font-size:20px}
    .panel p{margin:6px 0;color:#cfe7ff;line-height:1.4}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .btn{cursor:pointer;border-radius:12px;padding:8px 14px;background:#1f2937;border:1px solid rgba(255,255,255,.1);color:var(--fg);font-weight:700}
    .btn:hover{background:#334155}
    .btnAccent{background:var(--accent);color:#1a1a1a;border:none}
    .btnAccent:hover{background:#f59f0b}
    .banner{position:absolute;left:12px;right:12px;top:12px;padding:10px 12px;background:#19324dcc;border:1px solid var(--outline);border-radius:12px;text-align:center;font-weight:700;box-shadow:0 10px 30px rgba(0,0,0,.35);display:none}
    .banner--danger{background:#7f1d1dcc}
    .banner--warn{background:#78350fcc}
    .highlight{color:var(--accent2);font-weight:900;text-decoration:underline wavy var(--accent2) 1.5px}
    .audioBtn{position:absolute;left:12px;bottom:12px}
  </style>
</head>
<body>
  <header>
    <h1>HastaLuego</h1>
    <p class="muted">‚õµ Pixel-art r√©trogaming ‚Äî √âvite les rochers, passe du bon c√¥t√© des bou√©es et rejoins le <em>po(r)t de d√©part</em>.</p>
  </header>

  <div class="wrap">
    <div class="topbar">
      <div class="pill">Obstacles franchis : <span id="passed">0</span>/12</div>
      <div class="pill">Vitesse mer : <span id="spd">‚Äî</span></div>
    </div>

    <div class="board" id="board">
      <canvas id="game" aria-label="Mini-jeu HastaLuego (pixel)"></canvas>

      <!-- Intro -->
      <div class="overlay" id="intro">
        <div class="panel">
          <h2>√Ä l‚Äôaide des touches directionnelles, emm√®ne ton bateau √† bon port !</h2>
          <p><strong>ESPACE</strong> pour commencer (auto-d√©marrage dans 8 secondes).</p>
          <div class="row">
            <button class="btn btnAccent" id="startBtn">ESPACE</button>
            <button class="btn" id="audioBtn">Activer le son</button>
          </div>
          <p class="muted" style="margin-top:10px">Astuce : Haut/Bas ajustent l√©g√®rement la vitesse du d√©filement.</p>
        </div>
      </div>

      <!-- Banni√®re -->
      <div class="banner" id="banner"></div>

      <!-- Victoire -->
      <div class="overlay" id="win" style="display:none">
        <div class="panel">
          <h2>Bien jou√© !</h2>
          <p>Apr√®s 7 ans dans le m√™me bateau, je vais changer d‚Äô√©quipage et quitter Harris pour une autre aventure.</p>
          <p>Tu as prouv√© ta valeur aujourd‚Äôhui ; je t‚Äôinvite √† rejoindre de la m√™me fa√ßon mon pot de d√©part le <span class="highlight">jeudi 7 novembre</span>, √† la caf√®t, avant de se d√©haler vers une autre destination plus festive !</p>
          <div class="row">
            <button class="btn btnAccent" id="replayBtn">Rejouer</button>
          </div>
        </div>
      </div>

      <div class="hint">Fl√®ches / Espace</div>
      <button class="btn audioBtn" id="audioBtnFloat" style="display:none">üîà Activer le son</button>
    </div>
  </div>

  <!-- Audio (ajoute assets/hasta-luego.mp3 si tu as les droits) -->
  <audio id="bgm" preload="auto" playsinline>
    <source src="assets/hasta-luego.mp3" type="audio/mpeg"/>
  </audio>

<script>
(function(){
  // --- Constantes gameplay ---
  const OBSTACLE_TARGET = 12;
  const BASE_SCROLL = 140;      // px/s
  const BOAT_SPEED  = 220;      // d√©placement lat√©ral
  const SPAWN_BASE  = 2.5;      // ~ toutes 2.5 s
  const SIDE_MARGIN = 6;        // tol√©rance gauche/droite bou√©es

  // Bou√©es selon brief : rouges 30‚Äì50% (moiti√© gauche), vertes 50‚Äì70% (moiti√© droite)
  const RED_MIN=0.30, RED_MAX=0.50;
  const GREEN_MIN=0.50, GREEN_MAX=0.70;

  // DOM
  const board = document.getElementById('board');
  const canvas= document.getElementById('game');
  const ctx   = canvas.getContext('2d'); ctx.imageSmoothingEnabled=false;
  const banner= document.getElementById('banner');
  const intro = document.getElementById('intro');
  const win   = document.getElementById('win');
  const startBtn = document.getElementById('startBtn');
  const replayBtn= document.getElementById('replayBtn');
  const audioBtn = document.getElementById('audioBtn');
  const audioBtnFloat = document.getElementById('audioBtnFloat');
  const passedEl = document.getElementById('passed');
  const spdEl    = document.getElementById('spd');
  const bgm      = document.getElementById('bgm');

  // √âtat
  const keys = new Set();
  const size = { w:960, h:600, dpr:1 };
  const boat = { x:0, y:0, r:12 };
  let obstacles=[], flag=null, passed=0, scroll=BASE_SCROLL;
  let state='intro', nextSpawn=SPAWN_BASE, lastTs=0, raf=0, autoStartTO=null;

  // Utils
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const rand=(a,b)=>Math.random()*(b-a)+a;
  const now = ()=>performance.now();

  // Textures pixel (eau, √©cume, nuages)
  let waterPat=null, foamPat=null, clouds=[];
  function makePatterns(){
    const t=document.createElement('canvas'); t.width=t.height=16; const c=t.getContext('2d');
    c.fillStyle='#133a69'; c.fillRect(0,0,16,16);
    c.fillStyle='#1b4d8a'; for(let y=0;y<16;y+=2){ for(let x=0;x<16;x+=4){ c.fillRect(x,y,3,1); } }
    c.fillStyle='#2b6fb1'; c.fillRect(1,5,6,1); c.fillRect(9,5,6,1); c.fillRect(3,11,6,1);
    waterPat = ctx.createPattern(t,'repeat');

    const f=document.createElement('canvas'); f.width=f.height=16; const cf=f.getContext('2d');
    cf.fillStyle='rgba(255,255,255,0)'; cf.fillRect(0,0,16,16);
    cf.fillStyle='#c7ecff'; [[2,2],[4,2],[11,3],[7,7],[12,8],[3,10],[8,13],[14,14]].forEach(([x,y])=>cf.fillRect(x,y,1,1));
    foamPat = ctx.createPattern(f,'repeat');

    clouds = [
      {x:40,y:32,w:48,h:16,dx:12},
      {x:220,y:22,w:64,h:18,dx:10},
      {x:420,y:36,w:56,h:16,dx:14}
    ];
  }

  // Mesure (√©vite boucles RO)
  function applyBuffer(){
    const dpr=Math.min(2,window.devicePixelRatio||1);
    const r=board.getBoundingClientRect();
    size.w=Math.max(1,Math.floor(r.width)); size.h=Math.max(1,Math.floor(r.height)); size.dpr=dpr;
    canvas.width=Math.floor(size.w*dpr); canvas.height=Math.floor(size.h*dpr);
    if(ctx.setTransform) ctx.setTransform(dpr,0,0,dpr,0,0);
    if(!boat.x){ boat.x=size.w/2; boat.y=Math.floor(size.h*0.65); }
  }
  let roTick=false;
  const ro=new ResizeObserver(()=>{ if(!roTick){ roTick=true; requestAnimationFrame(()=>{ roTick=false; applyBuffer(); if(state!=='playing') draw(); }); }});
  ro.observe(board); window.addEventListener('resize', ()=>applyBuffer(), {passive:true});

  // Audio
  async function tryPlayAudio(){
    if(!bgm) return;
    try{ bgm.loop=true; await bgm.play(); audioBtnFloat.style.display='none'; }
    catch{ audioBtnFloat.style.display='inline-flex'; }
  }
  audioBtn.addEventListener('click', tryPlayAudio);
  audioBtnFloat.addEventListener('click', tryPlayAudio);

  // Banni√®res
  function showBanner(msg, kind='info'){
    banner.textContent=msg;
    banner.style.display='block';
    banner.className='banner'+(kind==='danger'?' banner--danger':kind==='warn'?' banner--warn':'');
    clearTimeout(showBanner._to); showBanner._to=setTimeout(()=>banner.style.display='none', 2200);
  }

  // Obstacles
  function spawnObstacle(){
    if(passed>=OBSTACLE_TARGET) return;
    const t=Math.random();
    let type='rock'; if(t<0.33) type='red'; else if(t<0.66) type='green';
    const y=-30; let x,s=14;
    if(type==='red'){ x = rand(size.w*RED_MIN, size.w*RED_MAX); s=12; }
    else if(type==='green'){ x = rand(size.w*GREEN_MIN, size.w*GREEN_MAX); s=12; }
    else { x = rand(size.w*0.22, size.w*0.78); s = rand(13,18); }
    obstacles.push({type,x,y,s,checked:false,hit:false});
  }

  function resetFromIntro(){
    obstacles.length=0; flag=null; passed=0; nextSpawn=SPAWN_BASE; scroll=BASE_SCROLL;
    passedEl.textContent='0'; spdEl.textContent='‚Äî';
    boat.x=size.w/2; boat.y=Math.floor(size.h*0.65);
    banner.style.display='none'; win.style.display='none'; intro.style.display='none';
    state='playing'; lastTs=now();
  }

  function crash(msg){
    state='dead'; showBanner(msg,'danger');
    setTimeout(()=>{ state='intro'; intro.style.display='flex'; tryPlayAudio(); scheduleAutoStart(); }, 1200);
  }

  function scheduleAutoStart(){
    clearTimeout(autoStartTO);
    autoStartTO=setTimeout(()=>{ if(state==='intro') { resetFromIntro(); tryPlayAudio(); } }, 8000);
  }

  // Dessins
  function drawSkyAndSea(t){
    const w=size.w,h=size.h;
    ctx.fillStyle='#6ec1ff'; ctx.fillRect(0,0,w,h);

    // soleil pixel
    const sx=w-76, sy=42;
    ctx.fillStyle= '#ffd43b'; ctx.fillRect(sx-10, sy-10, 20, 20);
    ctx.fillStyle= '#ffef99'; ctx.fillRect(sx-6, sy-6, 12, 12);
    ctx.fillStyle='#ffd43b'; ctx.fillRect(sx-1, sy-16, 2, 6); ctx.fillRect(sx-1, sy+10, 2, 6);
    ctx.fillRect(sx-16, sy-1, 6, 2); ctx.fillRect(sx+10, sy-1, 6, 2);

    // nuages
    ctx.fillStyle='#ffffff';
    clouds.forEach(cl=>{
      cl.x += (cl.dx*0.02); if(cl.x> w+40) cl.x = -80;
      const x=Math.floor(cl.x), y=Math.floor(cl.y);
      ctx.fillStyle='#ffffff'; ctx.fillRect(x, y, cl.w, cl.h);
      ctx.fillStyle='#e6f4ff'; ctx.fillRect(x+6, y+4, cl.w-12, cl.h-6);
      ctx.fillStyle='#cfe7ff'; ctx.fillRect(x+12, y+6, cl.w-22, cl.h-10);
    });

    // mer (pattern + √©cume) d√©filante
    const off = Math.floor((t*scroll*0.35)%16);
    ctx.save(); ctx.translate(0, off);
    ctx.fillStyle=waterPat; ctx.fillRect(0, h*0.35, w, h);
    ctx.fillStyle=foamPat;  ctx.globalAlpha=0.9; ctx.fillRect(0, h*0.35, w, h);
    ctx.restore(); ctx.globalAlpha=1;

    // scanlines
    ctx.fillStyle='rgba(0,0,0,0.07)';
    for(let y=0;y<h;y+=3){ ctx.fillRect(0,y,w,1); }
  }

  function drawBoat(){
    const b=boat;
    ctx.fillStyle='#20325a'; ctx.fillRect(Math.floor(b.x-10), Math.floor(b.y-4), 20, 8);
    ctx.fillStyle='#162748'; ctx.fillRect(Math.floor(b.x-10), Math.floor(b.y+1), 20, 3);
    ctx.fillStyle='#223a6e'; ctx.fillRect(Math.floor(b.x-1), Math.floor(b.y-10), 2, 6);
    ctx.fillStyle='#d1d5db'; ctx.fillRect(Math.floor(b.x-1), Math.floor(b.y-30), 2, 20);
    ctx.fillStyle='#f1f5f9'; ctx.beginPath();
    ctx.moveTo(b.x, b.y-30); ctx.lineTo(b.x, b.y-12); ctx.lineTo(b.x+16, b.y-18); ctx.closePath(); ctx.fill();
  }

  function drawRock(o){
    const x=Math.floor(o.x), y=Math.floor(o.y), s=Math.floor(o.s);
    ctx.fillStyle='var(--rock2)'; ctx.fillRect(x-s, y-s+2, s*2, s*2-2);
    ctx.fillStyle='var(--rock1)'; ctx.fillRect(x-s+2, y-s, s*2-4, s*2-4);
    ctx.fillStyle='var(--rockHL)'; ctx.fillRect(x- Math.floor(s*0.4), y- Math.floor(s*0.6), Math.floor(s*0.8), 2);
    ctx.strokeStyle='#00000055'; ctx.lineWidth=1; ctx.strokeRect(x-s+0.5, y-s+0.5, s*2-1, s*2-1);
  }

  function drawObstacle(o){
    if(o.type==='rock'){ drawRock(o); return; }
    if(o.type==='red'){
      const x=Math.floor(o.x-o.s), y=Math.floor(o.y-o.s), w=o.s*2, h=o.s*2;
      ctx.fillStyle='var(--red)'; ctx.fillRect(x,y,w,h);
      ctx.strokeStyle='#ffffffaa'; ctx.strokeRect(x+0.5,y+0.5,w-1,h-1);
    }else{ // green triangle
      ctx.fillStyle='var(--green)';
      ctx.beginPath(); ctx.moveTo(o.x, o.y - o.s);
      ctx.lineTo(o.x - o.s, o.y + o.s);
      ctx.lineTo(o.x + o.s, o.y + o.s);
      ctx.closePath(); ctx.fill();
      ctx.strokeStyle='#ffffffaa'; ctx.stroke();
    }
  }

  function drawFlag(){
    if(!flag) return;
    const f=flag;
    ctx.fillStyle='#e5e7eb'; ctx.fillRect(f.x-1, f.y-20, 2, 40);
    ctx.fillStyle='#fbbf24'; ctx.fillRect(f.x, f.y-18, 28, 10);
    ctx.fillStyle='#0b1022'; ctx.fillRect(f.x-30, f.y-30, 84, 12);
    ctx.fillStyle='#e5e7eb'; ctx.font='12px ui-monospace, monospace'; ctx.textBaseline='top';
    ctx.fillText('po(r)t de d√©part', f.x-26, f.y-29);
  }

  // Logique
  function spawnTick(dt){
    nextSpawn-=dt;
    if(nextSpawn<=0){ spawnObstacle(); nextSpawn=SPAWN_BASE*(0.9+Math.random()*0.35); }
  }

  function checkCollisions(){
    for(const o of obstacles){
      // rochers: collision circulaire
      if(o.type==='rock'){
        const d=Math.hypot(o.x-boat.x, o.y-boat.y);
        if(d<o.s+boat.r){ crash("Tu t‚Äôes √©chou√© ! Tu dois s√ªrement √™tre un quanti‚Ä¶"); return true; }
      }
    }
    return false;
  }

  function checkRulesAndCount(){
    for(const o of obstacles){
      if(o.checked) continue;
      if(o.y >= boat.y){
        o.checked = true;
        if(o.type==='red'){
          if(!(boat.x > o.x + SIDE_MARGIN)){
            crash("on doit passer √† droite des bou√©es b√¢bord rouges ! Marin d‚Äôeau douce !");
            return true;
          }
        }else if(o.type==='green'){
          if(!(boat.x < o.x - SIDE_MARGIN)){
            crash("on doit passer √† gauche des bou√©es tribord vertes ! M√™me Fred !");
            return true;
          }
        }
        passed++;
      }
    }
    return false;
  }

  function update(dt, t){
    if(keys.has('ArrowUp'))   scroll = clamp(scroll + 80*dt, 100, 260);
    if(keys.has('ArrowDown')) scroll = clamp(scroll - 80*dt,  80, 260);

    const vx = (keys.has('ArrowRight')?1:0) - (keys.has('ArrowLeft')?1:0);
    boat.x = clamp(boat.x + vx*BOAT_SPEED*dt, 16, size.w-16);

    if(state==='playing'){
      spawnTick(dt);
      obstacles.forEach(o=>o.y += scroll*dt);
      if(checkCollisions()) return;
      if(checkRulesAndCount()) return;

      if(passed>=OBSTACLE_TARGET && !flag){
        flag = { x: clamp(boat.x, size.w*0.35, size.w*0.65), y: -40 };
        state='finale';
      }
    }else if(state==='finale'){
      boat.y -= (scroll*0.5)*dt;
      obstacles.forEach(o=>o.y += scroll*dt);
      if(flag) flag.y += scroll*dt*0.6;
      if(flag && Math.hypot(boat.x-flag.x,(boat.y-10)-(flag.y-10))<28){
        state='won'; win.style.display='flex';
      }
    }

    obstacles = obstacles.filter(o=>o.y < size.h+40);
    passedEl.textContent=String(passed);
    spdEl.textContent=Math.round(scroll)+' px/s';
  }

  function draw(t){
    drawSkyAndSea(t);
    obstacles.forEach(drawObstacle);
    drawFlag();
    drawBoat();
  }

  function loop(ts){
    const dt=Math.min(.033, (ts-lastTs)/1000||0); lastTs=ts;
    draw(ts/1000);
    if(state==='playing' || state==='finale') update(dt, ts/1000);
    raf=requestAnimationFrame(loop);
  }

  // IO
  window.addEventListener('keydown', (e)=>{
    if(e.key===' '){
      e.preventDefault();
      if(state==='intro'){ resetFromIntro(); tryPlayAudio(); }
      return;
    }
    if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){
      e.preventDefault(); keys.add(e.key);
    }
  }, {passive:false});
  window.addEventListener('keyup', (e)=>{
    if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){
      keys.delete(e.key);
    }
  });

  startBtn.addEventListener('click', ()=>{ if(state==='intro'){ resetFromIntro(); tryPlayAudio(); }});
  replayBtn.addEventListener('click', ()=>{ win.style.display='none'; state='intro'; intro.style.display='flex'; scheduleAutoStart(); });

  function showIntro(){ state='intro'; intro.style.display='flex'; scheduleAutoStart(); tryPlayAudio(); }

  // Init
  makePatterns();
  applyBuffer();
  showIntro();
  lastTs=now();
  requestAnimationFrame(loop);

  // Self-tests (console)
  (function(){
    const res=[]; const assert=(c,m)=>res.push({ok:!!c,msg:m});
    assert(RED_MIN>=0.30 && RED_MAX<=0.50,'fen√™tre bou√©es rouges 30‚Äì50%');
    assert(GREEN_MIN>=0.50 && GREEN_MAX<=0.70,'fen√™tre bou√©es vertes 50‚Äì70%');
    assert(OBSTACLE_TARGET===12,'seuil obstacles = 12');
    console.log('[HastaLuego tests]', res.filter(r=>r.ok).length+'/'+res.length, res);
  })();
})();
</script>
</body>
</html>
