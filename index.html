<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>HastaLuego - Mini-Jeu</title>
  <style>
    /* --- Styles généraux --- */
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #4A90E2; }
    body { 
      /* On pourrait définir ici un motif pixelisé pour l'eau en background */
      background-image: 
        linear-gradient(90deg, #4A90E2 50%, #5CB3FF 50%),   /* vertical stripes pattern */
        linear-gradient(#4A90E2 50%, #5CB3FF 50%);
      background-size: 8px 8px; /* damier 8x8 */
      animation: scrollBg 5s linear infinite;
    }
    @keyframes scrollBg {
      0% { background-position-y: 0; }
      100% { background-position-y: 8px; } /* fait défiler le pattern de 8px */
    }

    /* --- Conteneur du jeu --- */
    #game {
      position: relative;
      width: 100%; height: 100%;
      /* Pas de background ici si on utilise celui du body */
      overflow: hidden;
    }

    /* --- Bateau --- */
    #boat {
      position: absolute;
      width: 32px; height: 32px;
      bottom: 33%; left: 50%; /* placé au tiers inférieur initialement */
      transform: translateX(-50%);
      /* Représentation simplifiée du bateau */
      background: brown; /* coque marron carrée (simplification) */
    }
    /* Voile du bateau en pseudo-élément */
    #boat::after {
      content: '';
      position: absolute;
      top: -20px; left: 8px; /* au-dessus de la coque, décalé à l'avant */
      border-left: 12px solid transparent;
      border-right: 12px solid transparent;
      border-bottom: 20px solid white; /* triangle blanc pour la voile */
    }

    /* --- Obstacles --- */
    .obstacle { position: absolute; width: 24px; height: 24px; }
    .rock {
      background: sienna; 
      /* on pourrait ajouter des petits carrés plus foncés pour l'irrégularité */
    }
    .buoy-red {
      background: #F00;
      /* effet 3D par ombres de bord */
      border-right: 4px solid #900; border-bottom: 4px solid #900;
    }
    .buoy-green {
      /* triangle vert: on utilise le pseudo-élément car un triangle n’a pas de largeur/hauteur propres */
      background: transparent;
    }
    .buoy-green::after {
      content: '';
      position: absolute;
      top: 0; left: 0;
      border-left: 12px solid transparent;
      border-right: 12px solid transparent;
      border-bottom: 24px solid limegreen;
      /* ombre sur la moitié droite du triangle */
      /* Par exemple, un pseudo élément suppl. ou box-shadow simulant l'ombre */
    }

    /* --- Drapeau d'arrivée --- */
    #finish-flag {
      position: absolute;
      top: -50px; /* hors écran initialement */
      right: 10%;
      width: 0; height: 0; /* on va le dessiner via border */
      border-left: 40px solid yellow;   /* le pavillon triangulaire */
      border-top: 20px solid transparent;
      border-bottom: 20px solid transparent;
    }
    #finish-flag::after { /* hampe du drapeau */
      content: '';
      position: absolute;
      left: -4px; top: -2px;
      width: 4px; height: 44px;
      background: gray;
    }
    #finish-flag span {
      position: absolute;
      left: -120px; top: -5px;
      width: 100px;
      color: black; font-weight: bold; font-size: 12px;
      text-align: right;
    }

    /* --- Écran de démarrage --- */
    #start-screen, #end-screen {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,50,0.8); /* voile foncé translucide */
      color: #FFF;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      text-align: center; padding: 20px;
    }
    #start-screen h1 { font-size: 1.5em; }
    #start-screen p { font-size: 1.2em; }
    #end-screen { display: none; }
    .highlight { color: yellow; font-weight: bold; }
  </style>
</head>
<body>
  <div id="game">
    <div id="boat"></div>
    <!-- Obstacles will be dynamically added here -->
    <div id="finish-flag"><span>po(r)t de départ</span></div>

    <div id="start-screen">
      <h1>À l’aide des touches directionnelles,<br/>emmène ton bateau à bon port !</h1>
      <p>ESPACE pour commencer</p>
    </div>
    <div id="end-screen"></div>
  </div>
  <audio id="bgm" src="hasta_luego.mp3" loop></audio>

  <script>
    let gameStarted = false, gameOver = false;
    const boat = document.getElementById('boat');
    const startScreen = document.getElementById('start-screen');
    const endScreen = document.getElementById('end-screen');
    const bgm = document.getElementById('bgm');

    // Obstacle parameters
    const obstacleData = [
      {type: 'rock', x: 60}, {type: 'buoy-red', x: 30},
      /* ... etc ... total 12 entries ... */
    ];
    let obstacles = []; // will hold DOM elements and their state (y position, etc.)
    let passedCount = 0;

    function startGame() {
      if (gameStarted) return;
      gameStarted = true;
      startScreen.style.display = 'none';
      // Play music (allowed because this is triggered by user interaction)
      bgm.play();
      // Initialize boat position
      boat.style.left = '50%';
      // Create obstacles elements
      obstacleData.forEach((obs, index) => {
        const div = document.createElement('div');
        div.classList.add('obstacle', obs.type);
        // set initial position above the screen
        div.style.top = (-100 * index) + 'px';
        div.style.left = obs.x + '%';
        document.getElementById('game').appendChild(div);
        obstacles.push({element: div, type: obs.type});
      });
      // Start the game loop
      requestAnimationFrame(gameLoop);
    }

    function endGame(success, message) {
      gameOver = true;
      // Show end screen with message
      endScreen.style.display = 'flex';
      endScreen.innerHTML = success ? 
        "<h1>Bien joué !</h1><p>" + message + "</p>" :
        "<h1>Game Over</h1><p>" + message + "</p>";
      // Optionally stop music or play a different tune
      // bgm.pause();
    }

    function gameLoop() {
      if (gameOver) return;
      // Move obstacles
      obstacles.forEach(obs => {
        const el = obs.element;
        let currentY = parseInt(el.style.top) || 0;
        currentY += 2; // move 2px down
        el.style.top = currentY + 'px';
        // Remove or count passed obstacles
        if (currentY > window.innerHeight) {
          passedCount++;
          // remove from DOM and array
          el.remove();
        }
      });
      // Check collisions or side-pass errors
      const boatRect = boat.getBoundingClientRect();
      obstacles.forEach(obs => {
        const rect = obs.element.getBoundingClientRect();
        // If overlap with boat (physical collision)
        if (
          boatRect.left < rect.left + rect.width &&
          boatRect.left + boatRect.width > rect.left &&
          boatRect.top < rect.top + rect.height &&
          boatRect.top + boatRect.height > rect.top
        ) {
          // Determine message based on type
          let msg = "";
          if (obs.type === 'rock') msg = "Tu t’es échoué ! Tu dois sûrement être un quanti…";
          else if (obs.type === 'buoy-red') msg = "On doit passer à droite des bouées bâbord rouges ! Marin d’eau douce !";
          else if (obs.type === 'buoy-green') msg = "On doit passer à gauche des bouées tribord vertes ! Même Fred !";
          endGame(false, msg);
        }
        // If boat and obstacle roughly at same vertical level, check side for buoys
        if ((rect.top < boatRect.bottom && rect.bottom > boatRect.top)) {
          if (obs.type === 'buoy-red') {
            const boatCenterX = boatRect.left + boatRect.width/2;
            const buoyCenterX = rect.left + rect.width/2;
            if (boatCenterX < buoyCenterX) {
              endGame(false, "On doit passer à droite des bouées bâbord rouges ! Marin d’eau douce !");
            }
          }
          if (obs.type === 'buoy-green') {
            const boatCenterX = boatRect.left + boatRect.width/2;
            const buoyCenterX = rect.left + rect.width/2;
            if (boatCenterX > buoyCenterX) {
              endGame(false, "On doit passer à gauche des bouées tribord vertes ! Même Fred !");
            }
          }
        }
      });
      // Check win condition
      if (!gameOver && passedCount >= obstacleData.length) {
        // Trigger finish flag and victory
        document.getElementById('finish-flag').style.top = '10px';
        endGame(true, "Après 7 ans dans le même bateau, ... <br/>\
          Rejoins mon <span class='highlight'>pot de départ</span> le jeudi 6 novembre !");
      }
      if (!gameOver) requestAnimationFrame(gameLoop);
    }

    // Keyboard controls
    document.addEventListener('keydown', e => {
      if (!gameStarted) {
        if (e.code === 'Space') startGame();
      } else {
        const step = 10;
        if (e.code === 'ArrowLeft') {
          boat.style.left = (boat.offsetLeft - step) + 'px';
        } else if (e.code === 'ArrowRight') {
          boat.style.left = (boat.offsetLeft + step) + 'px';
        }
      }
    });
    // Auto-start after 8s if not started
    setTimeout(() => { if (!gameStarted) startGame(); }, 8000);
  </script>
</body>
</html>
